<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GherkinPlanBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Kukumo::CORE</a> &gt; <a href="index.source.html" class="el_package">iti.kukumo.core.gherkin</a> &gt; <span class="el_source">GherkinPlanBuilder.java</span></div><h1>GherkinPlanBuilder.java</h1><pre class="source lang-java linenums">/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

/**
 * @author Luis IÃ±esta Gelabert - linesta@iti.es | luiinge@gmail.com
 */
package iti.kukumo.core.gherkin;


import java.util.*;
import java.util.function.Predicate;
import java.util.function.UnaryOperator;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;


import imconfig.Configurable;
import imconfig.Configuration;
import iti.commons.gherkin.*;
import iti.commons.jext.Extension;
import iti.kukumo.core.Kukumo;
import iti.kukumo.api.KukumoConfiguration;
import iti.kukumo.api.KukumoException;
import iti.kukumo.api.Resource;
import iti.kukumo.api.extensions.PlanBuilder;
import iti.kukumo.api.extensions.ResourceType;
import iti.kukumo.api.plan.Document;
import iti.kukumo.api.plan.NodeType;
import iti.kukumo.api.plan.PlanNodeBuilder;



@Extension(provider = &quot;iti.kukumo&quot;, name = &quot;kukumo-gherkin&quot;, extensionPoint = &quot;iti.kukumo.api.extensions.PlanBuilder&quot;, version = &quot;1.1&quot;)
<span class="fc" id="L38">public class GherkinPlanBuilder implements PlanBuilder, Configurable {</span>

    public static final String GHERKIN_PROPERTY = &quot;gherkinType&quot;;
    public static final String GHERKIN_TYPE_FEATURE = &quot;feature&quot;;
    public static final String GHERKIN_TYPE_SCENARIO = &quot;scenario&quot;;
    public static final String GHERKIN_TYPE_SCENARIO_OUTLINE = &quot;scenarioOutline&quot;;
    public static final String GHERKIN_TYPE_BACKGROUND = &quot;background&quot;;
    public static final String GHERKIN_TYPE_STEP = &quot;step&quot;;

<span class="fc" id="L47">    private Predicate&lt;PlanNodeBuilder&gt; scenarioFilter = (x -&gt; true);</span>
<span class="fc" id="L48">    private Pattern idTagPattern = null;</span>


    @Override
    public boolean acceptResourceType(ResourceType&lt;?&gt; resourceType) {
<span class="fc" id="L53">        return resourceType.contentType().equals(GherkinDocument.class);</span>
    }


    @Override
    public void configure(Configuration configuration) {
<span class="fc" id="L59">        configureFilterFromTagExpression(configuration);</span>
<span class="fc" id="L60">        configureIdTagPattern(configuration);</span>
<span class="fc" id="L61">    }</span>


    protected void configureFilterFromTagExpression(Configuration configuration) {
<span class="fc" id="L65">        String tagFilterExpression = configuration.get(KukumoConfiguration.TAG_FILTER, String.class)</span>
<span class="fc" id="L66">            .orElse(&quot;&quot;);</span>
<span class="pc bpc" id="L67" title="1 of 4 branches missed.">        if (tagFilterExpression != null &amp;&amp; !tagFilterExpression.isEmpty()) {</span>
<span class="fc" id="L68">            this.scenarioFilter = node -&gt; Kukumo.instance().createTagFilter(tagFilterExpression)</span>
<span class="fc" id="L69">                .filter(node.tags());</span>
        }
<span class="fc" id="L71">    }</span>


    protected void configureIdTagPattern(Configuration configuration) {
<span class="fc" id="L75">        this.idTagPattern = configuration.get(KukumoConfiguration.ID_TAG_PATTERN, String.class)</span>
<span class="fc" id="L76">            .map(this::nullIfEmpty)</span>
<span class="fc" id="L77">            .map(Pattern::compile)</span>
<span class="fc" id="L78">            .orElse(null);</span>
<span class="fc" id="L79">    }</span>


    private String nullIfEmpty(String string) {
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        return string.isEmpty() ? null : string;</span>
    }


    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public PlanNodeBuilder createPlan(List&lt;Resource&lt;?&gt;&gt; resources) {
<span class="fc" id="L90">        PlanNodeBuilder plan = new PlanNodeBuilder(NodeType.AGGREGATOR)</span>
<span class="fc" id="L91">            .setDisplayNamePattern(&quot;Test Plan&quot;);</span>
<span class="fc" id="L92">        List&lt;Resource&lt;GherkinDocument&gt;&gt; gherkinResources = resources.stream()</span>
<span class="fc" id="L93">            .map(x -&gt; (Resource&lt;GherkinDocument&gt;) x).collect(Collectors.toList());</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        for (Resource&lt;GherkinDocument&gt; gherkinResource : gherkinResources) {</span>
<span class="fc" id="L95">            plan.addChildIf(createFeature(gherkinResource), PlanNodeBuilder::hasChildren);</span>
<span class="fc" id="L96">        }</span>
<span class="fc" id="L97">        return plan;</span>
    }


    protected PlanNodeBuilder createFeature(Resource&lt;GherkinDocument&gt; gherkinResource) {
<span class="fc" id="L102">        Feature feature = gherkinResource.content().getFeature();</span>
<span class="fc" id="L103">        String location = gherkinResource.relativePath();</span>
<span class="fc" id="L104">        String language = feature.getLanguage();</span>
<span class="fc" id="L105">        PlanNodeBuilder node = newFeatureNode(feature, language, location);</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">        for (ScenarioDefinition abstractScenario : feature.getChildren()) {</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">            if (abstractScenario instanceof Scenario) {</span>
<span class="fc" id="L108">                node.addChildIf(</span>
<span class="fc" id="L109">                    createScenario(feature, (Scenario) abstractScenario, location, node),</span>
                    scenarioFilter
                );
<span class="fc bfc" id="L112" title="All 2 branches covered.">            } else if (abstractScenario instanceof ScenarioOutline) {</span>
<span class="fc" id="L113">                node.addChildIf(</span>
<span class="fc" id="L114">                    createScenarioOutline(</span>
                        feature,
                        (ScenarioOutline) abstractScenario,
                        location,
                        node
                    ),
                    scenarioFilter
                );
            }
<span class="fc" id="L123">        }</span>
<span class="fc" id="L124">        return node;</span>
    }


    protected PlanNodeBuilder createScenario(
        Feature feature,
        Scenario scenario,
        String location,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L134">        PlanNodeBuilder node = newScenarioNode(scenario, location, parentNode);</span>
<span class="fc" id="L135">        Optional&lt;PlanNodeBuilder&gt; backgroundSteps = createBackgroundSteps(feature, location, node);</span>
<span class="fc" id="L136">        backgroundSteps.ifPresent(background -&gt; node.addChild(background.copy()));</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">        for (Step step : scenario.getSteps()) {</span>
<span class="fc" id="L138">            node.addChild(createStep(step, location, parentNode.language(), node));</span>
<span class="fc" id="L139">        }</span>
<span class="fc" id="L140">        return node;</span>
    }


    protected PlanNodeBuilder createScenarioOutline(
        Feature feature,
        ScenarioOutline scenarioOutline,
        String location,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L150">        PlanNodeBuilder node = newScenarioOutlineNode(scenarioOutline, location, parentNode);</span>
<span class="fc" id="L151">        Optional&lt;PlanNodeBuilder&gt; backgroundSteps = createBackgroundSteps(feature, location, node);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        for (Examples examples : scenarioOutline.getExamples()) {</span>
<span class="fc" id="L153">            List&lt;PlanNodeBuilder&gt; scenarios = createScenariosFromExamples(</span>
                scenarioOutline,
                examples,
                node,
                backgroundSteps,
<span class="fc" id="L158">                parentNode.language(),</span>
                location
            );
<span class="fc" id="L161">            scenarios.forEach(node::addChild);</span>
<span class="fc" id="L162">        }</span>
<span class="fc" id="L163">        return node;</span>
    }


    protected List&lt;PlanNodeBuilder&gt; createScenariosFromExamples(
        ScenarioOutline scenarioOutline,
        Examples examples,
        PlanNodeBuilder scenarioOutlineNode,
        Optional&lt;PlanNodeBuilder&gt; backgroundSteps,
        String language,
        String location
    ) {
<span class="fc" id="L175">        List&lt;PlanNodeBuilder&gt; output = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L177">        List&lt;String&gt; variables = tableCells(examples.getTableHeader());</span>
<span class="fc" id="L178">        List&lt;List&lt;String&gt;&gt; values = examples.getTableBody().stream().map(this::tableCells)</span>
<span class="fc" id="L179">            .collect(Collectors.toList());</span>

<span class="fc" id="L181">        ArrayList&lt;PlanNodeBuilder&gt; outlineSteps = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">        for (Step step : scenarioOutline.getSteps()) {</span>
<span class="fc" id="L183">            outlineSteps.add(createStep(step, location, language, scenarioOutlineNode));</span>
<span class="fc" id="L184">        }</span>

<span class="fc bfc" id="L186" title="All 2 branches covered.">        for (int row = 0; row &lt; values.size(); row++) {</span>

<span class="fc" id="L188">            PlanNodeBuilder exampleScenario = new PlanNodeBuilder(NodeType.TEST_CASE)</span>
<span class="fc" id="L189">                .setId(id(</span>
<span class="fc" id="L190">                    scenarioOutline.getTags(),</span>
<span class="fc" id="L191">                    scenarioOutline.getName(),</span>
                    (&quot;_&quot; + (row + 1))
                ))
<span class="fc" id="L194">                .setName(trim(scenarioOutline.getName()) + &quot; [&quot; + (row + 1) + &quot;]&quot;)</span>
<span class="fc" id="L195">                .setLanguage(language)</span>
<span class="fc" id="L196">                .setSource(source(location, scenarioOutline.getLocation()))</span>
<span class="fc" id="L197">                .addTags(</span>
<span class="fc" id="L198">                    tags(</span>
<span class="fc" id="L199">                        scenarioOutlineNode.tags(),</span>
<span class="fc" id="L200">                        scenarioOutline.getTags(),</span>
<span class="fc" id="L201">                        scenarioOutlineNode.id()</span>
                    )
                )
<span class="fc" id="L204">                .addProperties(</span>
<span class="fc" id="L205">                    propertiesFromComments(scenarioOutlineNode, scenarioOutlineNode.properties())</span>
                )
<span class="fc" id="L207">                .addProperty(GHERKIN_PROPERTY, GHERKIN_TYPE_SCENARIO);</span>

<span class="fc" id="L209">            backgroundSteps.ifPresent(background -&gt; exampleScenario.addChild(background.copy()));</span>
<span class="fc" id="L210">            List&lt;PlanNodeBuilder&gt; exampleSteps = replaceOutlineVariables(</span>
                outlineSteps,
                variables,
<span class="fc" id="L213">                values.get(row)</span>
            );
<span class="fc" id="L215">            exampleSteps.forEach(exampleScenario::addChild);</span>

<span class="fc" id="L217">            output.add(exampleScenario);</span>

        }
<span class="fc" id="L220">        return output;</span>
    }


    protected PlanNodeBuilder newFeatureNode(
        Feature feature,
        String language,
        String location
    ) {
<span class="fc" id="L229">        return new PlanNodeBuilder(NodeType.AGGREGATOR)</span>
<span class="fc" id="L230">            .setId(id(feature.getTags(), feature.getName(), &quot;&quot;))</span>
<span class="fc" id="L231">            .setName(feature.getName())</span>
<span class="fc" id="L232">            .setDisplayNamePattern(&quot;{keyword}: {name}&quot;)</span>
<span class="fc" id="L233">            .setLanguage(language)</span>
<span class="fc" id="L234">            .setKeyword(feature.getKeyword())</span>
<span class="fc" id="L235">            .addDescription(splitAndTrim(feature.getDescription()))</span>
<span class="fc" id="L236">            .addTags(tags(feature.getTags()))</span>
<span class="fc" id="L237">            .setSource(source(location, feature.getLocation()))</span>
<span class="fc" id="L238">            .setUnderlyingModel(feature)</span>
<span class="fc" id="L239">            .addProperties(propertiesFromComments(feature, null))</span>
<span class="fc" id="L240">            .addProperty(GHERKIN_PROPERTY, GHERKIN_TYPE_FEATURE);</span>
    }


    protected PlanNodeBuilder newScenarioNode(
        Scenario scenario,
        String location,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L249">        return new PlanNodeBuilder(NodeType.TEST_CASE)</span>
<span class="fc" id="L250">            .setId(id(scenario.getTags(), scenario.getName(), &quot;&quot;))</span>
<span class="fc" id="L251">            .setName(trim(scenario.getName()))</span>
<span class="fc" id="L252">            .setDisplayNamePattern(&quot;[{id}] {keyword}: {name}&quot;)</span>
<span class="fc" id="L253">            .setLanguage(parentNode.language())</span>
<span class="fc" id="L254">            .setKeyword(trim(scenario.getKeyword()))</span>
<span class="fc" id="L255">            .addTags(tags(parentNode.tags(), scenario.getTags()))</span>
<span class="fc" id="L256">            .setSource(source(location, scenario.getLocation()))</span>
<span class="fc" id="L257">            .setUnderlyingModel(scenario)</span>
<span class="fc" id="L258">            .addProperties(propertiesFromComments(scenario, parentNode.properties()))</span>
<span class="fc" id="L259">            .addProperty(GHERKIN_PROPERTY, GHERKIN_TYPE_SCENARIO);</span>
    }


    protected PlanNodeBuilder newScenarioOutlineNode(
        ScenarioOutline scenarioOutline,
        String location,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L268">        return new PlanNodeBuilder(NodeType.AGGREGATOR)</span>
<span class="fc" id="L269">            .setId(id(scenarioOutline.getTags(), scenarioOutline.getName(), &quot;&quot;))</span>
<span class="fc" id="L270">            .setName(trim(scenarioOutline.getName()))</span>
<span class="fc" id="L271">            .setDisplayNamePattern(&quot;[{id}] {keyword}: {name}&quot;)</span>
<span class="fc" id="L272">            .setLanguage(parentNode.language())</span>
<span class="fc" id="L273">            .setKeyword(trim(scenarioOutline.getKeyword()))</span>
<span class="fc" id="L274">            .addTags(tags(parentNode.tags(), scenarioOutline.getTags()))</span>
<span class="fc" id="L275">            .setSource(source(location, scenarioOutline.getLocation()))</span>
<span class="fc" id="L276">            .setUnderlyingModel(scenarioOutline)</span>
<span class="fc" id="L277">            .setData(examplesAsDataTable(scenarioOutline.getExamples()))</span>
<span class="fc" id="L278">            .addProperties(propertiesFromComments(scenarioOutline, parentNode.properties()))</span>
<span class="fc" id="L279">            .addProperty(GHERKIN_PROPERTY, GHERKIN_TYPE_SCENARIO_OUTLINE);</span>
    }


    protected PlanNodeBuilder newStepNode(
        Step step,
        String location,
        String language,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L289">        return new PlanNodeBuilder(NodeType.STEP)</span>
<span class="fc" id="L290">            .setKeyword(trim(step.getKeyword()))</span>
<span class="fc" id="L291">            .setName(trim(step.getText()))</span>
<span class="fc" id="L292">            .setDisplayNamePattern(&quot;{keyword} {name}&quot;)</span>
<span class="fc" id="L293">            .setLanguage(language)</span>
<span class="fc" id="L294">            .setSource(source(location, step.getLocation()))</span>
<span class="fc" id="L295">            .setUnderlyingModel(step)</span>
<span class="fc" id="L296">            .addProperties(propertiesFromComments(step, parentNode.properties()))</span>
<span class="fc" id="L297">            .addProperty(GHERKIN_PROPERTY, GHERKIN_TYPE_STEP);</span>
    }


    protected Optional&lt;Background&gt; getBackground(Feature feature) {
<span class="fc" id="L302">        Background background = null;</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">        if (!feature.getChildren().isEmpty()</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">                        &amp;&amp; feature.getChildren().get(0) instanceof Background) {</span>
<span class="fc" id="L305">            background = (Background) feature.getChildren().get(0);</span>
        }
<span class="fc" id="L307">        return Optional.ofNullable(background);</span>
    }


    protected Optional&lt;PlanNodeBuilder&gt; createBackgroundSteps(
        Feature feature,
        String location,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L316">        Optional&lt;Background&gt; background = getBackground(feature);</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">        if (background.isPresent()) {</span>
<span class="fc" id="L318">            PlanNodeBuilder backgroundAggregator = new PlanNodeBuilder(NodeType.STEP_AGGREGATOR)</span>
<span class="fc" id="L319">                .setKeyword(background.get().getKeyword())</span>
<span class="fc" id="L320">                .setName(background.get().getName())</span>
<span class="fc" id="L321">                .setDisplayNamePattern(&quot;{keyword}: {name}&quot;)</span>
<span class="fc" id="L322">                .addTags(parentNode.tags())</span>
<span class="fc" id="L323">                .addProperties(propertiesFromComments(background.get(), parentNode.properties()))</span>
<span class="fc" id="L324">                .addProperty(GHERKIN_PROPERTY, GHERKIN_TYPE_BACKGROUND);</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">            for (Step step : background.get().getSteps()) {</span>
<span class="fc" id="L326">                backgroundAggregator.addChild(</span>
<span class="fc" id="L327">                    createStep(step, location, feature.getLanguage(), backgroundAggregator)</span>
                );
<span class="fc" id="L329">            }</span>
<span class="fc" id="L330">            return Optional.of(backgroundAggregator);</span>
        }
<span class="fc" id="L332">        return Optional.empty();</span>
    }


    protected PlanNodeBuilder createStep(
        Step step,
        String location,
        String language,
        PlanNodeBuilder parentNode
    ) {
<span class="fc" id="L342">        PlanNodeBuilder node = newStepNode(step, location, language, parentNode);</span>
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">        if (step.getArgument() != null) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (step.getArgument() instanceof DataTable) {</span>
<span class="nc" id="L345">                node.setData(</span>
<span class="nc" id="L346">                    new iti.kukumo.api.plan.DataTable(toArray((DataTable) step.getArgument()))</span>
                );
<span class="nc bnc" id="L348" title="All 2 branches missed.">            } else if (step.getArgument() instanceof DocString) {</span>
<span class="nc" id="L349">                node.setData(</span>
                    new Document(
<span class="nc" id="L351">                        ((DocString) step.getArgument()).getContent(),</span>
<span class="nc" id="L352">                        ((DocString) step.getArgument()).getContentType()</span>
                    )
                );
            }
        }
<span class="fc" id="L357">        return node;</span>
    }


    /*
     * Scenario outline variables follow the pattern: &lt;name&gt;
     */
    private List&lt;PlanNodeBuilder&gt; replaceOutlineVariables(
        ArrayList&lt;PlanNodeBuilder&gt; outlineSteps,
        List&lt;String&gt; variables,
        List&lt;String&gt; values
    ) {
<span class="fc" id="L369">        ArrayList&lt;PlanNodeBuilder&gt; exampleSteps = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">        for (PlanNodeBuilder outlineStep : outlineSteps) {</span>
<span class="fc" id="L371">            PlanNodeBuilder exampleStep = outlineStep.copy();</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">            for (int i = 0; i &lt; variables.size(); i++) {</span>
<span class="fc" id="L373">                String variableValue = values.get(i);</span>
<span class="fc" id="L374">                String variable = &quot;&lt;&quot; + variables.get(i) + &quot;&gt;&quot;;</span>
<span class="fc" id="L375">                UnaryOperator&lt;String&gt; replacer = s -&gt; s.replace(variable, variableValue);</span>
<span class="fc" id="L376">                exampleStep</span>
<span class="fc" id="L377">                    .setName(Optional.ofNullable(trim(exampleStep.name())).map(replacer).orElse(null))</span>
<span class="pc" id="L378">                    .setData(exampleStep.data().map(data -&gt; data.copyReplacingVariables(replacer)).orElse(null));</span>
            }
<span class="fc" id="L380">            exampleSteps.add(exampleStep);</span>
<span class="fc" id="L381">        }</span>
<span class="fc" id="L382">        return exampleSteps;</span>
    }


    private iti.kukumo.api.plan.DataTable examplesAsDataTable(List&lt;Examples&gt; examplesList) {
<span class="pc bpc" id="L387" title="2 of 4 branches missed.">        if (examplesList == null || examplesList.isEmpty()) {</span>
<span class="nc" id="L388">            return null;</span>
        }
<span class="fc" id="L390">        Examples examples = examplesList.get(0);</span>
<span class="fc" id="L391">        int rows = examples.getTableBody().size() + 1;</span>
<span class="fc" id="L392">        int columns = examples.getTableHeader().getCells().size();</span>
<span class="fc" id="L393">        String[][] dataTable = new String[rows][columns];</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">        for (int column = 0; column &lt; columns; column++) {</span>
<span class="fc" id="L395">            dataTable[0][column] = examples.getTableHeader().getCells().get(column).getValue();</span>
        }
<span class="fc bfc" id="L397" title="All 2 branches covered.">        for (int row = 1; row &lt; rows; row++) {</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">            for (int column = 0; column &lt; columns; column++) {</span>
<span class="fc" id="L399">                dataTable[row][column] = examples.getTableBody().get(row - 1).getCells().get(column)</span>
<span class="fc" id="L400">                    .getValue();</span>
            }
        }
<span class="fc" id="L403">        return new iti.kukumo.api.plan.DataTable(dataTable);</span>
    }


    private String[][] toArray(DataTable table) {
<span class="nc" id="L408">        TableRow header = table.getRows().get(0);</span>
<span class="nc" id="L409">        String[][] array = new String[table.getRows().size()][header.getCells().size()];</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">        for (int row = 0; row &lt; table.getRows().size(); row++) {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">            for (int column = 0; column &lt; header.getCells().size(); column++) {</span>
<span class="nc" id="L412">                array[row][column] = trim(</span>
<span class="nc" id="L413">                    table.getRows().get(row).getCells().get(column).getValue()</span>
                );
            }
        }
<span class="nc" id="L417">        return array;</span>
    }


    private List&lt;String&gt; splitAndTrim(String string) {
<span class="fc bfc" id="L422" title="All 2 branches covered.">        if (string == null) {</span>
<span class="fc" id="L423">            return Collections.emptyList();</span>
        }
<span class="fc" id="L425">        List&lt;String&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">        for (String line : string.split(&quot;\\u000D|\\u000A|\\u000D\\u000A&quot;)) {</span>
<span class="fc" id="L427">            lines.add(line.trim());</span>
        }
<span class="fc" id="L429">        return lines;</span>
    }


    private String trim(String string) {
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">        return string == null ? null : string.trim();</span>
    }


    private List&lt;String&gt; tags(List&lt;Tag&gt; tags) {
<span class="fc" id="L439">        return tags.stream().map(Tag::getName).map(s -&gt; s.substring(1)).distinct()</span>
<span class="fc" id="L440">            .collect(Collectors.toList());</span>
    }


    private Set&lt;String&gt; tags(Set&lt;String&gt; parentTags, Collection&lt;Tag&gt; tags, String... ignoredTags) {
<span class="fc" id="L445">        List&lt;String&gt; ignoredTagList = Arrays.asList(ignoredTags);</span>
<span class="fc" id="L446">        Set&lt;String&gt; tagList = tags.stream()</span>
<span class="fc" id="L447">            .map(Tag::getName)</span>
<span class="fc" id="L448">            .map(s -&gt; s.substring(1))</span>
<span class="fc bfc" id="L449" title="All 2 branches covered.">            .filter(s -&gt; !ignoredTagList.contains(s))</span>
<span class="fc" id="L450">            .collect(Collectors.toSet());</span>
<span class="fc" id="L451">        tagList.addAll(parentTags);</span>
<span class="fc" id="L452">        return tagList;</span>
    }


    protected String source(String file, Location location) {
<span class="fc bfc" id="L457" title="All 2 branches covered.">        return file.endsWith(&quot;]&quot;) ? file</span>
<span class="fc" id="L458">                        : file + &quot;[&quot; + location.getLine() + &quot;,&quot; + location.getColumn() + &quot;]&quot;;</span>
    }



    protected String id(List&lt;Tag&gt; tags, String nodeName, String suffix) {
<span class="fc" id="L464">        String idTag = null;</span>
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">        if (idTagPattern != null ) {</span>
<span class="fc" id="L466">            List&lt;String&gt; idTags = tags.stream().map(Tag::getName).map(s -&gt; s.substring(1))</span>
<span class="fc" id="L467">                    .map(idTagPattern::matcher)</span>
<span class="fc" id="L468">                    .filter(Matcher::matches).map(Matcher::group).collect(Collectors.toList());</span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">            if (idTags.size() &gt; 1) {</span>
<span class="nc" id="L470">                throw new KukumoException(&quot;More than one ID tag found in element {}&quot;, nodeName);</span>
            }
<span class="fc bfc" id="L472" title="All 2 branches covered.">            if (!idTags.isEmpty()) {</span>
<span class="fc" id="L473">                idTag = idTags.get(0);</span>
            }
        }
<span class="fc bfc" id="L476" title="All 2 branches covered.">        if (idTag == null) {</span>
<span class="fc" id="L477">            idTag = &quot;#&quot;+UUID.randomUUID().toString().substring(0,5);</span>
        }
<span class="fc" id="L479">        return idTag + suffix;</span>
    }




    private List&lt;String&gt; tableCells(TableRow tableRow) {
<span class="fc" id="L486">        return tableRow.getCells().stream().map(TableCell::getValue).collect(Collectors.toList());</span>
    }


    private Map&lt;String, String&gt; propertiesFromComments(
        Object node,
        Map&lt;String, String&gt; inheritedProperties
    ) {
<span class="fc" id="L494">        Map&lt;String, String&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">        if (inheritedProperties != null) {</span>
<span class="fc" id="L496">            properties.putAll(inheritedProperties);</span>
        }
<span class="fc bfc" id="L498" title="All 2 branches covered.">        if (node instanceof CommentedNode) {</span>
<span class="fc bfc" id="L499" title="All 2 branches covered.">            for (Comment comment : ((CommentedNode) node).getComments()) {</span>
<span class="fc" id="L500">                String text = comment.getText().strip();</span>
<span class="pc bpc" id="L501" title="1 of 4 branches missed.">                if (text.startsWith(&quot;#&quot;) &amp;&amp; text.contains(&quot;:&quot;)) {</span>
<span class="fc" id="L502">                    String[] parts = text.split(&quot;:&quot;,2);</span>
<span class="fc" id="L503">                    properties.put(parts[0].substring(1).strip(), parts[1].strip());</span>
                }
<span class="fc" id="L505">            }</span>
        }
<span class="fc" id="L507">        return properties;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>