<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Kukumo::Database Steps</a> &gt; <a href="index.source.html" class="el_package">iti.kukumo.database</a> &gt; <span class="el_source">SQLParser.java</span></div><h1>SQLParser.java</h1><pre class="source lang-java linenums">/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

package iti.kukumo.database;

import iti.kukumo.database.dataset.DataSet;
import net.sf.jsqlparser.JSQLParserException;
import net.sf.jsqlparser.expression.*;
import net.sf.jsqlparser.expression.operators.conditional.AndExpression;
import net.sf.jsqlparser.expression.operators.conditional.OrExpression;
import net.sf.jsqlparser.expression.operators.relational.EqualsTo;
import net.sf.jsqlparser.expression.operators.relational.ExpressionList;
import net.sf.jsqlparser.expression.operators.relational.IsNullExpression;
import net.sf.jsqlparser.parser.CCJSqlParserUtil;
import net.sf.jsqlparser.schema.Column;
import net.sf.jsqlparser.schema.Table;
import net.sf.jsqlparser.statement.Statement;
import net.sf.jsqlparser.statement.StatementVisitorAdapter;
import net.sf.jsqlparser.statement.Statements;
import net.sf.jsqlparser.statement.delete.Delete;
import net.sf.jsqlparser.statement.insert.Insert;
import net.sf.jsqlparser.statement.select.*;
import net.sf.jsqlparser.statement.update.Update;
import net.sf.jsqlparser.util.cnfexpression.MultiAndExpression;

import java.util.LinkedList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class SQLParser {

    private final CaseSensitivity caseSensitivity;

<span class="fc" id="L39">    public SQLParser(CaseSensitivity caseSensitivity) {</span>
<span class="fc" id="L40">        this.caseSensitivity = caseSensitivity;</span>
<span class="fc" id="L41">    }</span>

    public List&lt;Statement&gt; parseStatements(String sql) throws JSQLParserException {
<span class="fc" id="L44">        Statements stmt = CCJSqlParserUtil.parseStatements(sql);</span>
<span class="fc" id="L45">        return stmt.getStatements();</span>
    }

    public Optional&lt;Select&gt; toSelect(Statement statement) {
<span class="fc" id="L49">        Select result = new Select();</span>
<span class="fc" id="L50">        statement.accept(new StatementVisitorAdapter() {</span>
            @Override
            public void visit(Delete delete) {
<span class="fc" id="L53">                result.setSelectBody(createSelectBody(delete.getTable(), delete.getWhere()));</span>
<span class="fc" id="L54">            }</span>

            @Override
            public void visit(Update update) {
<span class="fc" id="L58">                result.setSelectBody(createSelectBody(update.getTable(), update.getWhere()));</span>
<span class="fc" id="L59">            }</span>

            @Override
            public void visit(Insert insert) {
<span class="fc" id="L63">                result.setSelectBody(createSelectBody(insert.getTable(),</span>
<span class="fc" id="L64">                        createWhere(insert.getColumns(), ((ExpressionList) insert.getItemsList()).getExpressions())));</span>
<span class="fc" id="L65">            }</span>
        });
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        return result.getSelectBody() == null ? Optional.empty() : Optional.of(result);</span>
    }

    public Select toSelect(DataSet dataSet) {
<span class="fc" id="L71">        Select result = new Select();</span>
<span class="fc" id="L72">        PlainSelect body = new PlainSelect();</span>
<span class="fc" id="L73">        body.addSelectItems(new AllColumns());</span>
<span class="fc" id="L74">        body.setFromItem(new Table(dataSet.table()));</span>
<span class="fc" id="L75">        body.setWhere(createWhere(dataSet.columns()));</span>
<span class="fc" id="L76">        result.setSelectBody(body);</span>
<span class="fc" id="L77">        return result;</span>
    }

    private SelectBody createSelectBody(FromItem table) {
<span class="fc" id="L81">        return createSelectBody(table, (Expression) null);</span>
    }

    private SelectBody createSelectBody(FromItem table, SelectItem item) {
<span class="fc" id="L85">        return createSelectBody(table, item, null);</span>
    }

    private SelectBody createSelectBody(FromItem table, Expression where) {
<span class="fc" id="L89">        return createSelectBody(table, new AllColumns(), where);</span>
    }

    private SelectBody createSelectBody(FromItem table, SelectItem item, Expression where) {
<span class="fc" id="L93">        PlainSelect body = new PlainSelect();</span>
<span class="fc" id="L94">        body.addSelectItems(item);</span>
<span class="fc" id="L95">        body.setFromItem(table);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (where != null) body.setWhere(where);</span>
<span class="fc" id="L97">        return body;</span>
    }

    public Expression createWhere(List&lt;Column&gt; columns, List&lt;Expression&gt; values) {
<span class="fc" id="L101">        List&lt;Expression&gt; result = new LinkedList&lt;&gt;();</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        for (int i = 0; i &lt; values.size(); i++) {</span>
<span class="fc" id="L103">            Expression expression = values.get(i);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (expression instanceof NullValue) {</span>
<span class="nc" id="L105">                IsNullExpression isNull = new IsNullExpression();</span>
<span class="nc" id="L106">                isNull.setLeftExpression(columns.get(i));</span>
<span class="nc" id="L107">                result.add(isNull);</span>
<span class="nc" id="L108">                continue;</span>
            }
<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (expression.getClass().getSimpleName().contains(&quot;Value&quot;)) {</span>
<span class="fc" id="L111">                EqualsTo equalsTo = new EqualsTo();</span>
<span class="fc" id="L112">                Function f = new Function();</span>
<span class="fc" id="L113">                f.setName(&quot;trim&quot;);</span>
<span class="fc" id="L114">                f.setParameters(new ExpressionList(columns.get(i)));</span>
<span class="fc" id="L115">                equalsTo.setLeftExpression(f);</span>
<span class="fc" id="L116">                equalsTo.setRightExpression(expression);</span>
<span class="fc" id="L117">                result.add(equalsTo);</span>
            }
        }
<span class="fc" id="L120">        return new MultiAndExpression(result);</span>
    }

    public Expression createWhere(String[] columns) {
<span class="fc" id="L124">        return createWhere(columns, true);</span>
    }

    public Expression createWhere(String[] columns, boolean nullControl) {
<span class="fc" id="L128">        List&lt;Expression&gt; expressions = Stream.of(columns)</span>
<span class="fc" id="L129">                .map(caseSensitivity::format)</span>
<span class="fc" id="L130">                .map(column -&gt; {</span>
<span class="fc" id="L131">                    EqualsTo exp = new EqualsTo();</span>
<span class="fc" id="L132">                    Function f = new Function();</span>
<span class="fc" id="L133">                    f.setName(&quot;trim&quot;);</span>
<span class="fc" id="L134">                    f.setParameters(new ExpressionList(new Column(column)));</span>
<span class="fc" id="L135">                    exp.setLeftExpression(f);</span>
<span class="fc" id="L136">                    exp.setRightExpression(new JdbcParameter());</span>
<span class="fc" id="L137">                    return exp;</span>
                })
<span class="fc" id="L139">                .map(exp -&gt; {</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">                    if (!nullControl) return exp;</span>
<span class="fc" id="L141">                    IsNullExpression cIsNull = new IsNullExpression();</span>
<span class="fc" id="L142">                    cIsNull.setLeftExpression(exp.getLeftExpression());</span>
<span class="fc" id="L143">                    IsNullExpression vIsNull = new IsNullExpression();</span>
<span class="fc" id="L144">                    vIsNull.setLeftExpression(exp.getRightExpression());</span>
<span class="fc" id="L145">                    return new Parenthesis(new OrExpression(exp, new Parenthesis(new AndExpression(cIsNull, vIsNull))));</span>
                })
<span class="fc" id="L147">                .collect(Collectors.toCollection(LinkedList::new));</span>
<span class="fc" id="L148">        return new MultiAndExpression(expressions);</span>
    }

    public Select sqlSelectFrom(String table) {
<span class="fc" id="L152">        Select select = new Select();</span>
<span class="fc" id="L153">        select.setSelectBody(createSelectBody(new Table(caseSensitivity.format(table))));</span>
<span class="fc" id="L154">        return select;</span>
    }

    public Select sqlSelectFrom(String table, String[] columns) {
<span class="nc" id="L158">        Select select = new Select();</span>
<span class="nc" id="L159">        select.setSelectBody(createSelectBody(new Table(caseSensitivity.format(table)), createWhere(columns)));</span>
<span class="nc" id="L160">        return select;</span>
    }

    public Select sqlSelectCountFrom(String table) {
<span class="fc" id="L164">        Select select = new Select();</span>
<span class="fc" id="L165">        Function count = new Function();</span>
<span class="fc" id="L166">        count.setName(&quot;count&quot;);</span>
<span class="fc" id="L167">        count.setAllColumns(true);</span>
<span class="fc" id="L168">        SelectItem countAll = new SelectExpressionItem(count);</span>
<span class="fc" id="L169">        select.setSelectBody(createSelectBody(new Table(caseSensitivity.format(table)), countAll));</span>
<span class="fc" id="L170">        return select;</span>
    }

    public Select sqlSelectCountFrom(String table, String where) throws JSQLParserException {
<span class="fc" id="L174">        Select select = new Select();</span>
<span class="fc" id="L175">        Function count = new Function();</span>
<span class="fc" id="L176">        count.setName(&quot;count&quot;);</span>
<span class="fc" id="L177">        count.setAllColumns(true);</span>
<span class="fc" id="L178">        SelectItem countAll = new SelectExpressionItem(count);</span>
<span class="fc" id="L179">        select.setSelectBody(createSelectBody(new Table(caseSensitivity.format(table)), countAll, CCJSqlParserUtil.parseCondExpression(where)));</span>
<span class="fc" id="L180">        return select;</span>
    }

    public Select sqlSelectCountFrom(String table, String[] columns) {
<span class="fc" id="L184">        Select select = new Select();</span>
<span class="fc" id="L185">        Function count = new Function();</span>
<span class="fc" id="L186">        count.setName(&quot;count&quot;);</span>
<span class="fc" id="L187">        count.setAllColumns(true);</span>
<span class="fc" id="L188">        SelectItem countAll = new SelectExpressionItem(count);</span>
<span class="fc" id="L189">        select.setSelectBody(createSelectBody(new Table(caseSensitivity.format(table)), countAll, createWhere(columns)));</span>
<span class="fc" id="L190">        return select;</span>
    }

    public Delete sqlDeleteFrom(String table) {
<span class="fc" id="L194">        return sqlDeleteFrom(table, null);</span>
    }

    public Delete sqlDeleteFrom(String table, String[] columns) {
<span class="fc" id="L198">        Delete delete = new Delete();</span>
<span class="fc" id="L199">        delete.setTable(new Table(caseSensitivity.format(table)));</span>
<span class="pc bpc" id="L200" title="1 of 4 branches missed.">        if (columns != null &amp;&amp; columns.length &gt; 0) delete.setWhere(createWhere(columns));</span>
<span class="fc" id="L201">        return delete;</span>
    }

    public Insert sqlInsertIntoValues(DataSet dataSet) {
<span class="fc" id="L205">        Insert insert = new Insert();</span>
<span class="fc" id="L206">        insert.setTable(new Table(caseSensitivity.format(dataSet.table())));</span>
<span class="fc" id="L207">        insert.setColumns(</span>
<span class="fc" id="L208">                Stream.of(dataSet.columns())</span>
<span class="fc" id="L209">                        .map(caseSensitivity::format).map(Column::new)</span>
<span class="fc" id="L210">                        .collect(Collectors.toCollection(LinkedList::new))</span>
        );
<span class="fc" id="L212">        insert.setItemsList(new ExpressionList(</span>
<span class="fc" id="L213">                Stream.of(dataSet.columns()).map(column -&gt; new JdbcParameter())</span>
<span class="fc" id="L214">                        .collect(Collectors.toCollection(LinkedList::new))</span>
        ));
<span class="fc" id="L216">        return insert;</span>
    }

    public Update sqlUpdateSet(DataSet dataSet, String[] columns) {
<span class="fc" id="L220">        Update update = new Update();</span>
<span class="fc" id="L221">        update.setTable(new Table(caseSensitivity.format(dataSet.table())));</span>
<span class="fc" id="L222">        List&lt;String&gt; setColumns = Stream.of(dataSet.columns())</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">                .filter(column -&gt; !columns[0].equals(column))</span>
<span class="fc" id="L224">                .collect(Collectors.toCollection(LinkedList::new));</span>
<span class="fc" id="L225">        update.setColumns(setColumns.stream().map(Column::new).collect(Collectors.toCollection(LinkedList::new)));</span>
<span class="fc" id="L226">        update.setExpressions(setColumns.stream().map(column -&gt; new JdbcParameter()).collect(Collectors.toCollection(LinkedList::new)));</span>
<span class="fc" id="L227">        update.setWhere(createWhere(columns, false));</span>
<span class="fc" id="L228">        return update;</span>
    }

    public String extractValue(Expression expression) {
<span class="nc" id="L232">        StringBuilder builder = new StringBuilder();</span>
<span class="nc" id="L233">        expression.accept(new ExpressionVisitorAdapter() {</span>
            @Override
            public void visit(DateTimeLiteralExpression literal) {
<span class="nc" id="L236">                builder.append(literal.getValue());</span>
<span class="nc" id="L237">            }</span>

            @Override
            public void visit(JdbcParameter value) {
<span class="nc" id="L241">                builder.append(&quot;?&quot;);</span>
<span class="nc" id="L242">            }</span>

            @Override
            public void visit(DoubleValue value) {
<span class="nc" id="L246">                builder.append(value.getValue());</span>
<span class="nc" id="L247">            }</span>

            @Override
            public void visit(LongValue value) {
<span class="nc" id="L251">                builder.append(value.getStringValue());</span>
<span class="nc" id="L252">            }</span>

            @Override
            public void visit(DateValue value) {
<span class="nc" id="L256">                builder.append(value.getValue());</span>
<span class="nc" id="L257">            }</span>

            @Override
            public void visit(TimeValue value) {
<span class="nc" id="L261">                builder.append(value.getValue());</span>
<span class="nc" id="L262">            }</span>

            @Override
            public void visit(TimestampValue value) {
<span class="nc" id="L266">                builder.append(value.getValue());</span>
<span class="nc" id="L267">            }</span>

            @Override
            public void visit(StringValue value) {
<span class="nc" id="L271">                builder.append(value.getValue());</span>
<span class="nc" id="L272">            }</span>

            @Override
            public void visit(HexValue hexValue) {
<span class="nc" id="L276">                builder.append(hexValue.getValue());</span>
<span class="nc" id="L277">            }</span>
        });
<span class="nc" id="L279">        return builder.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>