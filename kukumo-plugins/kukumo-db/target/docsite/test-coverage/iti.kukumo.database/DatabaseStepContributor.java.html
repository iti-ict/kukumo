<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseStepContributor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Kukumo::Database Steps</a> &gt; <a href="index.source.html" class="el_package">iti.kukumo.database</a> &gt; <span class="el_source">DatabaseStepContributor.java</span></div><h1>DatabaseStepContributor.java</h1><pre class="source lang-java linenums">/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

/**
 * @author Luis IÃ±esta Gelabert - linesta@iti.es | luiinge@gmail.com
 */
package iti.kukumo.database;


import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.sql.Connection;
import java.sql.SQLException;

import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.hamcrest.Matchers;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import iti.commons.jext.Extension;
import iti.kukumo.api.Kukumo;
import iti.kukumo.api.KukumoException;
import iti.kukumo.api.annotations.I18nResource;
import iti.kukumo.api.annotations.Step;
import iti.kukumo.api.annotations.TearDown;
import iti.kukumo.api.datatypes.Assertion;
import iti.kukumo.api.extensions.StepContributor;
import iti.kukumo.api.plan.DataTable;
import iti.kukumo.api.plan.Document;
import iti.kukumo.database.dataset.CsvDataSet;
import iti.kukumo.database.dataset.DataSet;
import iti.kukumo.database.dataset.DataTableDataSet;
import iti.kukumo.database.dataset.InlineDataSet;
import iti.kukumo.database.dataset.MultiDataSet;
import iti.kukumo.database.dataset.OoxmlDataSet;
import iti.kukumo.util.KukumoLogger;
import net.sf.jsqlparser.JSQLParserException;
import org.apache.commons.io.IOUtils;
import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.hamcrest.Matcher;
import org.hamcrest.Matchers;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.*;
import java.sql.Connection;
import java.sql.SQLException;



@Extension(provider = &quot;iti.kukumo&quot;, name = &quot;database-steps&quot;, version = &quot;1.1&quot;)
@I18nResource(&quot;iti_kukumo_kukumo-database&quot;)
<span class="fc" id="L59">public class DatabaseStepContributor implements StepContributor {</span>

<span class="fc" id="L61">    private static final Logger LOGGER = KukumoLogger</span>
<span class="fc" id="L62">        .of(LoggerFactory.getLogger(&quot;iti.kukumo.database&quot;));</span>

<span class="fc" id="L64">    private static ConnectionManager connectionManager = Kukumo.extensionManager()</span>
<span class="fc" id="L65">        .getExtension(ConnectionManager.class)</span>
<span class="pc" id="L66">        .orElseThrow(() -&gt; new KukumoException(&quot;Cannot find a connection manager&quot;));</span>

<span class="fc" id="L68">    private final ConnectionParameters connectionParameters = new ConnectionParameters();</span>
<span class="fc" id="L69">    private final DatabaseHelper helper = new DatabaseHelper(connectionParameters,this::connection,this::nullSymbol);</span>

    private Connection connection;
    private String xlsIgnoreSheetRegex;
    private String nullSymbol;
    private String csvFormat;
    private boolean enableCleanupUponCompletion;


    public Connection connection() throws SQLException {
<span class="fc bfc" id="L79" title="All 2 branches covered.">        if (connection == null) {</span>
<span class="fc" id="L80">            connection = connectionManager.obtainConnection(connectionParameters);</span>
<span class="fc" id="L81">            LOGGER.debug(</span>
                    &quot;Using database connection of type {} provided by {contributor}&quot;,
<span class="fc" id="L83">                    connection.getClass().getSimpleName(),</span>
<span class="fc" id="L84">                    connectionManager.info()</span>
            );
        } else {
<span class="fc" id="L87">            connection = connectionManager.refreshConnection(connection, connectionParameters);</span>
        }
<span class="fc" id="L89">        return connection;</span>
    }


    public ConnectionParameters getConnectionParameters() {
<span class="fc" id="L94">        return connectionParameters;</span>
    }


    public void setXlsIgnoreSheetRegex(String ignoreSheetRegex) {
<span class="fc" id="L99">        this.xlsIgnoreSheetRegex = ignoreSheetRegex;</span>
<span class="fc" id="L100">    }</span>

    public void setNullSymbol(String nullSymbol) {
<span class="fc" id="L103">        this.nullSymbol = nullSymbol;</span>
<span class="fc" id="L104">    }</span>


    public void setCsvFormat(String csvFormat) {
<span class="fc" id="L108">        this.csvFormat = csvFormat;</span>
<span class="fc" id="L109">    }</span>


    public void setEnableCleanupUponCompletion(boolean enableCleanupUponCompletion) {
<span class="fc" id="L113">        this.enableCleanupUponCompletion = enableCleanupUponCompletion;</span>
<span class="fc" id="L114">    }</span>

    public void setCaseSensitivity(CaseSensitivity caseSensitivity) {
<span class="fc" id="L117">        this.helper.setCaseSensitivity(caseSensitivity);</span>
<span class="fc" id="L118">    }</span>


    private Assertion&lt;Long&gt; matcherEmpty() {
<span class="fc" id="L122">        return new MatcherAssertion&lt;&gt;(Matchers.equalTo(0L));</span>
    }


    private Assertion&lt;Long&gt; matcherNonEmpty() {
<span class="fc" id="L127">        return new MatcherAssertion&lt;&gt;(Matchers.greaterThan(0L));</span>
    }

    private String nullSymbol() {
<span class="fc" id="L131">        return nullSymbol;</span>
    }

    @TearDown(order = 1)
    public void cleanUp() {
<span class="fc" id="L136">        helper.cleanUp();</span>
<span class="fc" id="L137">    }</span>


    @TearDown(order = 2)
    public void releaseConnection() throws SQLException {
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (this.connection != null) {</span>
<span class="fc" id="L143">            connectionManager.releaseConnection(connection);</span>
        }
<span class="fc" id="L145">    }</span>

    @Step(&quot;db.define.cleanup.document&quot;)
    public void setManualCleanup(Document document) {
<span class="nc" id="L149">        helper.setCleanUpOperations(document.getContent());</span>
<span class="nc" id="L150">    }</span>


    @Step(&quot;db.define.cleanup.file&quot;)
    public void setManualCleanup(File file) throws IOException {
<span class="nc" id="L155">        try (Reader reader = new FileReader(file)) {</span>
<span class="nc" id="L156">            helper.setCleanUpOperations(IOUtils.toString(reader), file.toString());</span>
        }
<span class="nc" id="L158">    }</span>

    @Step(
        value = &quot;db.define.connection.parameters&quot;,
           args = { &quot;url:text&quot;, &quot;username:text&quot;, &quot;password:text&quot; }
    )
    public void setConnectionParameters(String url, String username, String password) {
<span class="nc" id="L165">        LOGGER.debug(</span>
            &quot;Setting database connection parameters [url={}, username={}, password={}]&quot;,
            url,
            username,
            password
        );
<span class="nc" id="L171">        this.connectionParameters.url(url).username(username).password(password);</span>
<span class="nc" id="L172">    }</span>


    @Step(&quot;db.action.script.document&quot;)
    public void executeSQLScript(Document document) throws SQLException, JSQLParserException {
<span class="nc" id="L177">        helper.executeSQLStatements(document.getContent(), enableCleanupUponCompletion);</span>
<span class="nc" id="L178">    }</span>


    @Step(&quot;db.action.script.file&quot;)
    public void executeSQLScript(File file) throws IOException, SQLException, JSQLParserException {
<span class="nc" id="L183">        try (Reader reader = new FileReader(file)) {</span>
<span class="nc" id="L184">            helper.executeSQLStatements(IOUtils.toString(reader), file.toString(), enableCleanupUponCompletion);</span>
        }
<span class="nc" id="L186">    }</span>


    @Step(value = &quot;db.action.insert.from.data&quot;, args = &quot;word&quot;)
    public void insertFromDataTable(
        String table,
        DataTable dataTable
    ) throws IOException, SQLException {
<span class="fc" id="L194">        try (DataSet dataSet = new DataTableDataSet(table, dataTable, nullSymbol)) {</span>
<span class="fc" id="L195">            helper.deleteDataSet(dataSet, false);</span>
<span class="fc" id="L196">            helper.insertDataSet(dataSet.copy(), enableCleanupUponCompletion);</span>
        }
<span class="fc" id="L198">    }</span>


    @Step(&quot;db.action.insert.from.xls&quot;)
    public void insertFromXLSFile(File file) throws IOException, SQLException {
<span class="nc" id="L203">        try (MultiDataSet multiDataSet = new OoxmlDataSet(file, xlsIgnoreSheetRegex, nullSymbol)) {</span>
<span class="nc" id="L204">            helper.deleteMultiDataSet(multiDataSet, false);</span>
<span class="nc" id="L205">            helper.insertMultiDataSet(multiDataSet.copy(), enableCleanupUponCompletion);</span>
        }
<span class="nc" id="L207">    }</span>


    @Step(value = &quot;db.action.insert.from.csv&quot;, args = { &quot;csv:file&quot;, &quot;table:word&quot; })
    public void insertFromCSVFile(File file, String table) throws IOException, SQLException {
<span class="nc" id="L212">        try (DataSet dataSet = new CsvDataSet(table, file, csvFormat, nullSymbol)) {</span>
<span class="nc" id="L213">            helper.deleteDataSet(dataSet, false);</span>
<span class="nc" id="L214">            helper.insertDataSet(dataSet.copy(), enableCleanupUponCompletion);</span>
        }
<span class="nc" id="L216">    }</span>


    @Step(value = &quot;db.action.delete.from.data&quot;, args = &quot;word&quot;)
    public void deleteFromDataTable(
        String table,
        DataTable dataTable
    ) throws IOException, SQLException {
<span class="nc" id="L224">        try (DataSet dataSet = new DataTableDataSet(table, dataTable, nullSymbol)) {</span>
<span class="nc" id="L225">            helper.deleteDataSet(dataSet, enableCleanupUponCompletion);</span>
        }
<span class="nc" id="L227">    }</span>


    @Step(&quot;db.action.delete.from.xls&quot;)
    public void deleteFromXLSFile(
        File file
    ) throws IOException, SQLException, InvalidFormatException {
<span class="nc" id="L234">        try (MultiDataSet multiDataSet = new OoxmlDataSet(</span>
            file, xlsIgnoreSheetRegex, nullSymbol
        )) {
<span class="nc" id="L237">            helper.deleteMultiDataSet(multiDataSet, enableCleanupUponCompletion);</span>
        }
<span class="nc" id="L239">    }</span>


    @Step(value = &quot;db.action.delete.from.csv&quot;, args = { &quot;csv:file&quot;, &quot;table:word&quot; })
    public void deleteFromCSVFile(File file, String table) throws IOException, SQLException {
<span class="nc" id="L244">        try (DataSet dataSet = new CsvDataSet(table, file, csvFormat, nullSymbol)) {</span>
<span class="nc" id="L245">            helper.deleteDataSet(dataSet, enableCleanupUponCompletion);</span>
        }
<span class="nc" id="L247">    }</span>


    @Step(value = &quot;db.action.clear.table.all&quot;, args = &quot;word&quot;)
    public void clearTable(String table) throws SQLException {
<span class="fc" id="L252">        helper.truncateTable(table);</span>
<span class="fc" id="L253">    }</span>


    @Step(value = &quot;db.action.clear.table.row.one.column&quot;, args = { &quot;table:word&quot;, &quot;column:word&quot;,
                    &quot;value:text&quot; })
    public void clearTableRowOneColumn(
        String table,
        String column,
        String value
    ) throws SQLException, IOException {
<span class="nc" id="L263">        try (DataSet dataSet = new InlineDataSet(</span>
            table, new String[] { column }, new Object[] { value }, nullSymbol
        )) {
<span class="nc" id="L266">            helper.deleteDataSet(dataSet, false);</span>
        }
<span class="nc" id="L268">    }</span>


    @Step(value = &quot;db.action.clear.table.row.two.columns&quot;, args = { &quot;table:word&quot;, &quot;column1:word&quot;,
                    &quot;value1:text&quot;, &quot;column2:word&quot;, &quot;value2:text&quot; })
    public void clearTableRowTwoColumns(
        String table,
        String column1,
        String value1,
        String column2,
        String value2
    ) throws SQLException, IOException {
<span class="nc" id="L280">        try (DataSet dataSet = new InlineDataSet(</span>
            table, new String[] { column1, column2 }, new Object[] { value1, value2 }, nullSymbol
        )) {
<span class="nc" id="L283">            helper.deleteDataSet(dataSet, false);</span>
        }
<span class="nc" id="L285">    }</span>


    @Step(value = &quot;db.assert.table.exists.row.single.id&quot;, args = { &quot;id:text&quot;, &quot;table:word&quot; })
    public void assertRowExistsBySingleId(String id, String table) throws SQLException {
<span class="nc" id="L290">        String keyColumn = helper.primaryKey(table).get()[0];</span>
<span class="nc" id="L291">        helper.assertCountRowsInTableByColumns(</span>
<span class="nc" id="L292">            matcherNonEmpty(),</span>
            table,
            new String[] { keyColumn },
            new Object[] { id }
        );
<span class="nc" id="L297">    }</span>


    @Step(value = &quot;db.assert.table.exists.row.one.column&quot;, args = { &quot;table:word&quot;, &quot;column:word&quot;,
                    &quot;value:text&quot; })
    public void assertRowExistsByOneColumn(
        String table,
        String column,
        String value
    ) throws SQLException {
<span class="nc" id="L307">        helper.assertCountRowsInTableByColumns(</span>
<span class="nc" id="L308">            matcherNonEmpty(),</span>
            table,
            new String[] { column },
            new Object[] { value }
        );
<span class="nc" id="L313">    }</span>


    @Step(value = &quot;db.assert.table.exists.row.two.columns&quot;, args = { &quot;table:word&quot;, &quot;column1:word&quot;,
                    &quot;value1:text&quot;, &quot;column2:word&quot;, &quot;value2:text&quot; })
    public void assertRowExistsByTwoColumns(
        String table,
        String column1,
        String value1,
        String column2,
        String value2
    ) throws SQLException {
<span class="nc" id="L325">        helper.assertCountRowsInTableByColumns(</span>
<span class="nc" id="L326">            matcherNonEmpty(),</span>
            table,
            new String[] { column1, column2 },
            new Object[] { value1, value2 }
        );
<span class="nc" id="L331">    }</span>


    @Step(value = &quot;db.assert.table.exists.sql.where&quot;, args = { &quot;table:word&quot; })
    public void assertRowExistsByClause(String table, Document clause) throws SQLException, JSQLParserException {
<span class="nc" id="L336">        helper.assertCountRowsInTableByClause(matcherNonEmpty(), table, clause.getContent());</span>
<span class="nc" id="L337">    }</span>


    @Step(value = &quot;db.assert.table.exists.data&quot;, args = &quot;table:word&quot;)
    public void assertDataTableExists(
        String table,
        DataTable dataTable
    ) throws IOException, SQLException {
<span class="nc" id="L345">        try (DataSet dataSet = new DataTableDataSet(table, dataTable, nullSymbol)) {</span>
<span class="nc" id="L346">            helper.assertDataSetExists(dataSet);</span>
        }
<span class="nc" id="L348">    }</span>


    @Step(&quot;db.assert.table.exists.xls&quot;)
    public void assertXLSFileExists(
        File file
    ) throws InvalidFormatException, IOException, SQLException {
<span class="nc" id="L355">        try (MultiDataSet multiDataSet = new OoxmlDataSet(</span>
            file, xlsIgnoreSheetRegex, nullSymbol
        )) {
<span class="nc" id="L358">            helper.assertMultiDataSetExists(multiDataSet);</span>
        }
<span class="nc" id="L360">    }</span>


    @Step(value = &quot;db.assert.table.exists.csv&quot;, args = { &quot;csv:file&quot;, &quot;table:word&quot; })
    public void assertCSVFileExists(File file, String table) throws IOException, SQLException {
<span class="nc" id="L365">        try (DataSet dataSet = new CsvDataSet(table, file, csvFormat, nullSymbol)) {</span>
<span class="nc" id="L366">            helper.assertDataSetExists(dataSet);</span>
        }
<span class="nc" id="L368">    }</span>


    @Step(value = &quot;db.assert.table.not.exists.row.single.id&quot;, args = { &quot;id:text&quot;, &quot;table:word&quot; })
    public void assertRowNotExistsBySingleId(String id, String table) throws SQLException {
<span class="nc" id="L373">        String keyColumn = helper.primaryKey(table).get()[0];</span>
<span class="nc" id="L374">        helper.assertCountRowsInTableByColumns(</span>
<span class="nc" id="L375">            matcherEmpty(),</span>
            table,
            new String[] { keyColumn },
            new Object[] { id }
        );
<span class="nc" id="L380">    }</span>


    @Step(value = &quot;db.assert.table.not.exists.row.one.column&quot;, args = { &quot;table:word&quot;, &quot;column:word&quot;,
                    &quot;value:text&quot; })
    public void assertRowNotExistsByOneColumn(
        String table,
        String column,
        String value
    ) throws SQLException {
<span class="nc" id="L390">        helper.assertCountRowsInTableByColumns(</span>
<span class="nc" id="L391">            matcherEmpty(),</span>
            table,
            new String[] { column },
            new Object[] { value }
        );
<span class="nc" id="L396">    }</span>


    @Step(value = &quot;db.assert.table.not.exists.row.two.columns&quot;, args = { &quot;table:word&quot;,
                    &quot;column1:word&quot;, &quot;value1:text&quot;, &quot;column2:word&quot;, &quot;value2:text&quot; })
    public void assertRowNotExistsByTwoColumns(
        String table,
        String column1,
        String value1,
        String column2,
        String value2
    ) throws SQLException {
<span class="nc" id="L408">        helper.assertCountRowsInTableByColumns(</span>
<span class="nc" id="L409">            matcherEmpty(),</span>
            table,
            new String[] { column1, column2 },
            new Object[] { value1, value2 }
        );
<span class="nc" id="L414">    }</span>


    @Step(value = &quot;db.assert.table.not.exists.sql.where&quot;, args = { &quot;table:word&quot; })
    public void assertRowNotExistsByClause(String table, Document clause) throws SQLException, JSQLParserException {
<span class="nc" id="L419">        helper.assertCountRowsInTableByClause(matcherEmpty(), table, clause.getContent());</span>
<span class="nc" id="L420">    }</span>


    @Step(value = &quot;db.assert.table.not.exists.data&quot;, args = &quot;table:word&quot;)
    public void assertDataTableNotExists(
        String table,
        DataTable dataTable
    ) throws IOException, SQLException {
<span class="nc" id="L428">        try (DataSet dataSet = new DataTableDataSet(table, dataTable, nullSymbol)) {</span>
<span class="nc" id="L429">            helper.assertDataSetNotExists(dataSet);</span>
        }
<span class="nc" id="L431">    }</span>


    @Step(value = &quot;db.assert.table.count.row.one.column&quot;, args = { &quot;table:word&quot;, &quot;column:word&quot;,
                    &quot;value:text&quot;, &quot;matcher:long-assertion&quot; })
    public void assertRowCountByOneColumn(
        String table,
        String column,
        String value,
        Assertion&lt;Long&gt; matcher
    ) throws SQLException {
<span class="fc" id="L442">        helper.assertCountRowsInTableByColumns(</span>
            matcher,
            table,
            new String[] { column },
            new Object[] { value }
        );
<span class="fc" id="L448">    }</span>


    @Step(value = &quot;db.assert.table.count.row.two.columns&quot;, args = { &quot;table:word&quot;, &quot;column1:word&quot;,
                    &quot;value1:text&quot;, &quot;column2:word&quot;, &quot;value2:text&quot;, &quot;matcher:long-assertion&quot; })
    public void assertRowCountByOneColumn(
        String table,
        String column1,
        String value1,
        String column2,
        String value2,
        Assertion&lt;Long&gt; matcher
    ) throws SQLException {
<span class="nc" id="L461">        helper.assertCountRowsInTableByColumns(</span>
            matcher,
            table,
            new String[] { column1, column2 },
            new Object[] { value1, value2 }
        );
<span class="nc" id="L467">    }</span>


    @Step(value = &quot;db.assert.table.count.sql.where&quot;, args = { &quot;table:word&quot;, &quot;matcher:long-assertion&quot; })
    public void assertRowCountByClause(
        String table,
        Assertion&lt;Long&gt; matcher,
        Document clause
    ) throws SQLException, JSQLParserException {
<span class="nc" id="L476">        helper.assertCountRowsInTableByClause(matcher, table, clause.getContent());</span>
<span class="nc" id="L477">    }</span>


    @Step(value = &quot;db.assert.table.count.data&quot;, args = { &quot;table:word&quot;, &quot;matcher:long-assertion&quot; })
    public void assertDataTableCount(
        String table,
        Assertion&lt;Long&gt; matcher,
        DataTable dataTable
    ) throws IOException, SQLException {
<span class="nc" id="L486">        try (DataSet dataSet = new DataTableDataSet(table, dataTable, nullSymbol)) {</span>
<span class="nc" id="L487">            helper.assertCountRowsInTableByDataSet(dataSet, matcher);</span>
        }
<span class="nc" id="L489">    }</span>


    @Step(&quot;db.assert.table.not.exists.xls&quot;)
    public void assertXLSFileNotExists(
        File file
    ) throws InvalidFormatException, IOException, SQLException {
<span class="nc" id="L496">        try (MultiDataSet multiDataSet = new OoxmlDataSet(</span>
            file, xlsIgnoreSheetRegex, nullSymbol
        )) {
<span class="nc" id="L499">            helper.assertMultiDataSetNotExists(multiDataSet);</span>
        }
<span class="nc" id="L501">    }</span>


    @Step(value = &quot;db.assert.table.not.exists.csv&quot;, args = { &quot;csv:file&quot;, &quot;table:word&quot; })
    public void assertCSVFileNotExists(File file, String table) throws IOException, SQLException {
<span class="nc" id="L506">        try (DataSet dataSet = new CsvDataSet(table, file, csvFormat, nullSymbol)) {</span>
<span class="nc" id="L507">            helper.assertDataSetNotExists(dataSet);</span>
        }
<span class="nc" id="L509">    }</span>


    @Step(value = &quot;db.assert.table.empty&quot;, args = &quot;word&quot;)
    public void assertTableIsEmpty(String table) throws SQLException, JSQLParserException {
<span class="fc" id="L514">        helper.assertCountRowsInTableByClause(matcherEmpty(), table, &quot;1=1&quot;);</span>
<span class="fc" id="L515">    }</span>


    @Step(value = &quot;db.assert.table.not.empty&quot;, args = &quot;word&quot;)
    public void assertTableIsNotEmpty(String table) throws SQLException, JSQLParserException {
<span class="fc" id="L520">        helper.assertCountRowsInTableByClause(matcherNonEmpty(), table, &quot;1=1&quot;);</span>
<span class="fc" id="L521">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>